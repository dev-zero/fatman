#!/bin/bash -l
#

# ----- SLURM JOB SUBMIT SCRIPT -----
#SBATCH --export=ALL
#SBATCH --error=slurm.%J.err
#SBATCH --output=slurm.%J.out
#SBATCH --exclusive

################ CHANGE this section  (begin) ##########################
# -- job info --
#SBATCH --account=uzh1
#SBATCH --job-name={workdir}
#SBATCH --time=23:59:00

# -- number of nodes --
#SBATCH --nodes=4               # of nodes            (default =  1)
#SBATCH --ntasks-per-node=36    # of MPI tasks/node   (default = 36)
#SBATCH --cpus-per-task=1       # of OMP threads/task (default =  1)
#SBATCH --ntasks-per-core=1     # HT (default = 1, HyperThreads = 2)

# -- the program and input file --
INP="pw.inp"
SCRATCHDIR='/scratch/daint/rkoitz/deltatests/espresso/{workdir}/'
INPDIR='/users/rkoitz/deltatests/espresso/{workdir}/'
########################################################################



################ NOTHING to be changed here ############################
MAX_THREADS_PER_NODE=48 # PizDora maximum

# -- modules to load --
module load espresso/5.2.0

# -- definition: function to start a calculation --
slurm_startjob() {{
  NTASKS=${{SLURM_NTASKS}}
  pool=`echo "${{NTASKS}} / 2" | bc`

  echo ' --------------------------------------------------------------'
  echo ' |        --- COPYING TO SCRATCH ---                          |'
  echo ' --------------------------------------------------------------'le
  
  mkdir -p $SCRATCHDIR
  sed -i "s|pseudo_dir.*,|pseudo_dir='./',|g" pw.inp
  cp $INPDIR/* $SCRATCHDIR

  cd $SCRATCHDIR

  echo ' --------------------------------------------------------------'
  echo ' |        --- RUNNING JOB ---                                 |'
  echo ' --------------------------------------------------------------'

  export OMP_NUM_THREADS=${{SLURM_CPUS_PER_TASK}}
  if [ ${{OMP_NUM_THREADS}} -gt 1 ]; then
    export SLURM_CPU_BIND="sockets"
  fi

  /usr/bin/time -p srun \
    --bcast=/tmp/${{USER}} \
    --ntasks ${{SLURM_NTASKS}} \
    --ntasks-per-node ${{SLURM_NNODES}} \
    --cpus-per-task ${{OMP_NUM_THREADS}} \
    pw.x -npool ${{pool}} -i ${{INP}} > ${{INP}}.out

  srun --ntasks ${{SLURM_NTASKS}} \
    --ntasks-per-node ${{SLURM_NNODES}} \
    --cpus-per-task ${{OMP_NUM_THREADS}} \
    numactl -s

  srun --ntasks ${{SLURM_NTASKS}} \
    --ntasks-per-node ${{SLURM_NNODES}} \
    --cpus-per-task ${{OMP_NUM_THREADS}} \
    numactl -H

  en=`grep "!    total energy              =" ${{INP}}.out | awk '{{printf "%24.18f", $5 * 13.605697827758654 / {natom} }}'` 

  echo "req = requests.post(RESULTS_URL, data={{'energy': $en, 'task_id': {id} }}, verify=False); req.raise_for_status(); done_task = req.json();" >> /users/rkoitz/deltatests/update_fatman.py

  echo "req = requests.patch(SERVER + '{taskupdate}', data={{'status': 'done'}}, verify=False); req.raise_for_status(); task = req.json()" >> /users/rkoitz/deltatests/update_fatman.py

  cp $SCRATCHDIR/*out $INPDIR
  echo ' --------------------------------------------------------------'
  echo ' |        --- DONE ---                                        |'
  echo ' --------------------------------------------------------------'
}}

# -- start the calculation --
slurm_startjob

exit 0
